<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>utils\model.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Model.html">Model</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/model.html">model</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: utils\model.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * A generic model class. This is instantiated by specialized model classes
 * which represent e.g. database entities.
 *
 * @module model
 */
var utils = require(__dirname + &#x27;/../utils/utils&#x27;),
	_ = require(&#x27;lodash&#x27;);

/**
 * @class Model
 * @constructor
 */
var Model = function () {

};

/**
 * The select statement for retrieving values.
 * The statement ust be written so that a WHERE clause can be appended
 * without producing a syntax error.
 * @property select
 * @type String
 */
Model.prototype.select = &#x27;&#x27;;

/**
 * The list of attributes. Key is the attribute (model) name, value is
 * the column name as used in the SQL string, which may include a table
 * or alias prefix.
 * @property attributes
 * @type Object
 */
Model.prototype.attributes = {};

/**
 * The key column used for &quot;findById&quot;
 * @property keyCol
 * @type String
 */
Model.prototype.keyCol = &#x27;&#x27;;


/**
 * Number of objects to be retrieved by default on findAll()
 * @property limit
 * @type Number
 */
Model.prototype.limit = 10;

/**
 * Default sort order.
 * This is a string consisting of a comma-separated list of model
 * attributes, each optionally followed by a space and
 * the literal &#x27;ASC&#x27; or &#x27;DESC&#x27; to specify the direction.
 *
 * Examples:
 * * &#x27;projectDate&#x27; ... order by project date ascending
 * * &#x27;projectDate DESC&#x27; ... order by project date descending
 * * &#x27;projectDate desc&#x27; ... order by project date descending (case insensitive)
 * * &#x27;clientId DESC, invoiceDate&#x27; ... order by client ID descending, then by invoice date
 * @property orderBy
 * @type String
 */
Model.prototype.orderBy = &#x27;&#x27;;


/**
 * Map alternative names for REST parameters
 * @property paramMap
 * @private
 */
Model.prototype.paramMap = {
	&#x27;n&#x27;: &#x27;limit&#x27;,
	&#x27;p&#x27;: &#x27;page&#x27;
};

/**
 * Maps alternative names for REST parameters to the &quot;official&quot; ones.
 * The passed parameters list is manipulated and the modified list
 * will be returned as well. Parameters which are not defined in the
 * mapping will be left untouched.
 * @method mapParams
 * @param params {Object} the parameters object
 * @return {Object} the modified parameters list
 */
Model.prototype.mapParams = function (params) {
	_(params).forIn(function (value, key) {
		if (this.paramMap[key]) {
			params[this.paramMap[key]] = value;
			delete params[key];
		}
	}, this);
	return params;
};

/**
 * Finds a specific record by its primary ID and return it
 * @method findById
 * @param id {Integer} the primary ID to be searched for. The columnn name
 *   to be used for this is defined in the property this.keyCol.
 * @param callback {Function} a callback function which is called when the
 *   record has been retrieved. It must accept two parameters:
 *   data (the record data as array with length==1) and err (error
 *   object).
 */
Model.prototype.findById = function (id, callback) {

	var where = this.keyCol + &#x27;=&#x27; + parseInt(id);

	var sql = this.select + &#x27; where &#x27; + where;
	logger.verbose(&#x27;=====&gt; (in model.js) NEW select is [&#x27; + sql + &#x27;]&#x27;);


	dbPool.getConnection(function (err, connection) {

		// query the database to some data
		connection.query(sql, function (err, rows) {

			var result;
			if (err === null) {
				result = utils.changeKeysToCamelCase(rows);
				if (result instanceof Error) {
					err = {&#x27;msg&#x27;: &#x27;Error at mapping keys to JSON keys: &#x27; + result};
				}
			}

			// close connection
			connection.release();

			callback(result, err);
		});
	});

};

/**
 * Builds a valid &quot;ORDER BY&quot; string suitable for an SQL statement. Basically this
 * helper function does just a translation of all attribute names in the given
 * orderBy string, translating them from model attribute names to the database
 * entity names (column names). The keywords &quot;ASC&quot; and &quot;DESC&quot; are recognized and
 * will be preserved.
 *
 * Example:
 * The input string &quot;clientId, date DESC&quot; will be translated to &quot;client_id, date DESC&quot;
 *
 * @method buildOrderByString
 * @private
 * @param orderBy
 * @return {string}
 */
Model.prototype.buildOrderByString = function (orderBy) {
	var sort = &#x27;&#x27;,
		sortFields = [];

	var isAttr = function (a) {
		return this.attributes[a] ? true : false;
	};

	if (orderBy) {
		// split orderBy string to get all involved fields
		logger.verbose(&#x27;orderBy property is: &#x27; + orderBy);

		var f = orderBy.split(&#x27;,&#x27;);
		_(f).forEach(function (attr) {
			var attrPlusDirection;
			if (attrPlusDirection = attr.match(/^ *\b(.+)\b *(ASC|DESC) *$/i)) {
//				if (isAttr(attrPlusDirection[0])) {
				var trimmedAttr = attrPlusDirection[1].trim();
				if (this.attributes[trimmedAttr]) {
					sortFields.push(this.attributes[trimmedAttr] + &#x27; &#x27; + attrPlusDirection[2].toUpperCase().trim());
				} else {
					logger.error(&#x27;Specified &quot;order by&quot; attribute [%s] is not found in the list of attributes&#x27;, trimmedAttr);
					// ... and ignore illegal field
				}
			} else {
				attr = attr.trim();
				// no ASC/DESC modifier
//				if (isAttr(attr)) {

				if (this.attributes[attr]) {
					sortFields.push(this.attributes[attr]);
				} else {
					logger.error(&#x27;Specified &quot;order by&quot; attribute [%s] is not found in the list of attributes&#x27;, attr);
					// ... and ignore illegal field
				}
			}
		}, this);

		if (sortFields.length) {
			sort = &#x27;ORDER BY &#x27; + sortFields.join(&#x27;, &#x27;);
		}
		return sort;
	}
}

/**
 * Finds a specific record by its primary ID and return it
 * @method findAll
 * @param params {Object} object containing parameters for the query.
 *   Parameter set depends on the model instance, but typical parameters are:
 *   * &#x27;fields&#x27; ... restrict output to the specified attributes
 *   * &#x27;orderBy&#x27; ... an order by expression (comma-separated list of attributes,
 *     each optionally followed by &#x27;ASC&#x27; or &#x27;DESC&#x27; (case insensitive)
 *   * &#x27;n&#x27;/&#x27;limit&#x27; ... specify number of records to be delivered at a maximum, of not specified, theconfigured
 *       default value will be used.
 *   * &#x27;p&#x27;/&#x27;page&#x27; ... number of page to be delivered. The size of one page can be set with the parameter
 *      &#x27;limit&#x27;, defaulting to the default value otherwise. The first page is page 1.
 * @param callback {Function} a callback function which is called when the
 *   records have been retrieved. It must accept two parameters:
 *   data (the record data as array of retrieved records) and err (error
 *   object).
 */
Model.prototype.findAll = function (params, callback) {

	var constraints = [ &#x27;1=1&#x27;], // find constraints, default: not constrained
		fields, // list of fields to be displayed in the output
		orderBy = this.orderBy, // order by fields
		limit = [this.limit, 1], // limit/pageNr for limit/offset clause
		limitClause, // assembled limit clause
		whereClause, // assembled where clause
		sortClause; // assembled sort clause

	this.mapParams(params);

	if (params.fields) {
		fields = params.fields.split(&#x27;,&#x27;);
	}

	if (params.orderBy) {
		orderBy = params.orderBy;
	}
	sortClause = this.buildOrderByString(orderBy)

	// build &#x27;where&#x27; constraint
	whereClause = constraints.join(&#x27; and &#x27;);

	if (params.limit) {
		limit[0] = params.limit;
	}
	if (params.page) {
		limit[1] = params.page;
	}
	if (limit[0]) {
		limitClause = &#x27;LIMIT &#x27; + limit[0];
		if (limit[1]) {
			limitClause += &#x27; OFFSET &#x27; + (limit[1] - 1) * limit[0];
		}
	}
	;


	var sql = this.select + &#x27; where &#x27; + _.compact([whereClause, sortClause, limitClause]).join(&#x27; &#x27;);
	logger.verbose(&#x27;=====&gt; (in model.js) NEW select is [&#x27; + sql + &#x27;]&#x27;);

	dbPool.getConnection(function (err, connection) {

		// query the database to some data
		connection.query(sql, function (err, rows) {

			var result;
			if (err === null) {
				result = utils.changeKeysToCamelCase(rows);
				if (fields) {
					// filter output fields
					result = utils.filterProperties(result, fields);
				}
				if (result instanceof Error) {
					err = {&#x27;msg&#x27;: &#x27;Error at mapping keys to JSON keys: &#x27; + result};
				}
			}

			// close connection
			connection.release();

			callback(result, err);
		});
	});

};

/**
 * Inserts a new record into the database.
 * @method add
 * @param obj {Object} the object to be written
 * @param callback {Function} a callback function which is called when the
 *   record has been written. It must accept two parameters:
 *   data (the record data as array of retrieved records) and err (error
 *   object).
 */
Model.prototype.add = function (obj, callback) {

	logger.verbose(&#x27;User attempts to post a new record&#x27;, { body: req.body });

	var obj = req.body;

	// remove unacceptable fields
	for (key in obj) {
		if (!acceptedPropertiesApi[key] || acceptedPropertiesApi[key].indexOf(&#x27;add&#x27;) == -1) {
			logger.verbose(&#x27;Removed attribute [&#x27; + key + &#x27;] (illegal over API)&#x27;);
			delete obj[key];
		}
	}

	// convert date fields
	[ &#x27;starttime&#x27;, &#x27;endtime&#x27; ].forEach(function (field) {
		if (obj[field]) {
			obj[field] = formatDate(obj[field]);
		}
	});


	// set additional (calculated) attributes, these will not be escaped,
	// but used literally in the query string. The keys here are exactly
	// the database table column names, no changing of case will take place
	var calculatedAttributes = {
		cdate: &quot;now()&quot;,
		mdate: &quot;now()&quot;,
		user_id: userId
	};

	// begin input validation
	// ----------------------
	var ok = true; // optimistic assumption

	// check for mandatory fields
	if (!obj.starttime) {
		res.send(400, error.error({
			errorCode: 1003,
			message: &#x27;Missing starttime parameter - starttime is mandatory&#x27;
		}));
		ok = false;
	}

	if (ok) {
		// input is ok, let&#x27;s write to DB
		// ------------------------------
		dbPool.getConnection(function (err, connection) {


			// convert case of the column names into database syntax
			obj = utils.changeKeysToSnakeCase(obj);
			var dataFields = utils.getInsertLists(obj, global.mysql.escape);
			var calcFields = utils.getInsertLists(calculatedAttributes);
			var sql = &#x27;INSERT into records(&#x27;
				+ [dataFields[&#x27;keys&#x27;], calcFields[&#x27;keys&#x27;]].join(&#x27;,&#x27;)
				+ &#x27;) select &#x27;
				+ [dataFields[&#x27;values&#x27;], calcFields[&#x27;values&#x27;]].join(&#x27;,&#x27;);

			logger.verbose(&quot;SQL = &quot; + sql);
			connection.query(sql, function (err, rows) {

				if (err != null) {
					res.send(400, &quot;Query error:&quot; + err);
				} else {
					// Shows the result on console window
					res.send(201, {
						insertId: rows[&#x27;insertId&#x27;],
						db: rows
					});
				}
			});

			// close connection
			connection.release();
		});
	}
};

module.exports = Model;
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
